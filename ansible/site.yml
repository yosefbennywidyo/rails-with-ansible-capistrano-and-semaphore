- hosts: yosefbennywidyo_digital_ocean
  remote_user: root
  become: yes
  tasks:
    - include: tasks/user_check/check_root_is_logged_in.yml

    - name: Update all packages to the latest version
      apt:
        upgrade: dist

    - include: tasks/authentication_setup/deploy_user_setup.yml

    - include: tasks/ruby_setup/ruby-install_setup.yml

    - include: tasks/authentication_setup/setup_authorized_key_for_deploy_user.yml
    
    - include: tasks/user_check/check_deploy_is_logged_in.yml

    - include: tasks/ruby_setup/install_ruby_3-0-0.yml
    
    - include: tasks/ruby_setup/chruby_setup_for_deploy_user.yml

    - include: tasks/ruby_setup/install_bundler.yml

    - include: tasks/nginx_setup/install_nginx.yml

    - name: Upload nginx config
      copy:
        src: tasks/nginx_setup/nginx_config
        dest: /etc/nginx/sites-available/rails
      notify:
        - Restart nginx

    - name: Recursively change directory permission "/home/deploy/apps/current/public/"
      ansible.builtin.file:
        path: /home/deploy/apps/current/public/
        state: directory
        mode: '644'
        recurse: yes
        owner: deploy
        group: root

    - name: Recursively change directory permission "/home/deploy/apps/releases/"
      ansible.builtin.file:
        path: /home/deploy/apps/releases/
        state: directory
        mode: '644'
        recurse: yes
        owner: deploy
        group: root
    
    - name: Recursively change directory permission "/home/deploy/apps/shared/tmp/sockets/"
      ansible.builtin.file:
        path: /home/deploy/apps/shared/tmp/sockets/
        state: directory
        mode: '644'
        recurse: yes
        owner: deploy
        group: root

    - name: Disable default nginx config
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify:
        - Restart nginx
    - name: Enable nginx config
      file:
        src: /etc/nginx/sites-available/rails
        dest: /etc/nginx/sites-enabled/rails
        state: link
      notify:
        - Restart nginx
  handlers:
    - name: Restart nginx
      service: name=nginx state=restarted