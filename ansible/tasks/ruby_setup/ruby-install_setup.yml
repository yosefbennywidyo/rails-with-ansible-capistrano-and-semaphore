- name: Install Ruby dependencies
  apt:
    name: ['git-core', 'gcc', 'autoconf', 'bison', 'build-essential', 'checkinstall', 'zlib1g-dev', 'openssl', 'libssl-dev', 'libyaml-dev', 'libreadline-dev', 'libreadline6-dev', 'libxml2-dev', 'libffi-dev', 'libncurses5-dev', 'libxslt1-dev', 'libcurl4-openssl-dev', 'software-properties-common', 'libffi-dev', 'zlib1g-dev', 'postgresql', 'postgresql-contrib', 'nodejs', 'yarn', 'libjemalloc-dev', 'software-properties-common', 'libpq-dev']

- name: Create rails user and grant privs
  become: true
  become_user: postgres
  community.postgresql.postgresql_user:
    name: ansible_rails
    password: db_password
    role_attr_flags: CREATEDB,NOSUPERUSER

- name: Download ruby-install
  become: no
  get_url:
    url: https://github.com/postmodern/ruby-install/archive/v0.8.1.tar.gz
    dest: /home/deploy/ruby-install-0.8.1.tar.gz

- name: Extract ruby-install tarball
  unarchive:
    src: /home/deploy/ruby-install-0.8.1.tar.gz
    dest: /home/deploy
    creates: /home/deploy/ruby-install-0.8.1
    remote_src: yes

- name: Install NVM
  shell: |
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.37.2/install.sh | bash
  args:
    creates: "/home/deploy/.nvm/nvm.sh"
    warn: false

- name: Verify NVM
  shell: |
    source ~/.bashrc && nvm -v
  args:
    warn: false

- name: Install node 15.5.1
  shell: |
    nvm install 15.5.1 && nvm alias default 15.5.1
  args:
    creates: "/home/deploy/.nvm/versions/node-15.5.1"
    chdir: "/home/deploy/"
    executable: /bin/bash
    warn: false

- name: Install YVM
  args:
    warn: false
  shell: |
    curl -s https://raw.githubusercontent.com/tophat/yvm/master/scripts/install.js | node

- name: Install yarn 1.22.10
  shell: |
    /bin/bash -c "source ~/.yvm/yvm.sh && yvm install 1.22.10 && yvm alias default 1.22.10"